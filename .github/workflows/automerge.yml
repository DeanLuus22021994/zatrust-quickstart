name: Auto-merge Dependencies

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  checks: read
  issues: write # allow commenting on PRs reliably

concurrency:
  group: automerge-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  automerge:
    name: Auto-merge dependency PR
    if: >-
      !github.event.pull_request.draft &&
      (contains(github.event.pull_request.labels.*.name, 'dependencies') ||
       contains(github.event.pull_request.labels.*.name, 'renovate')) &&
      (github.event.pull_request.user.login == 'dependabot[bot]' || github.event.pull_request.user.login == 'renovate[bot]')
    runs-on: ubuntu-latest
    steps:
      - name: Ensure PR is up to date
        uses: actions/github-script@v7
        with:
          script: |
            // Optionally re-run if merge conflicts exist; placeholder for future logic
            core.info('Pre-merge validation step executed.')
      - name: Auto-merge minor/patch dependency PRs
        uses: fastify/github-action-merge-dependabot@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-method: squash
          target: minor
          allow-merge-commit: false
          use-github-auto-merge: true
      - name: Comment merge status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            core.info(`Evaluated auto-merge for #${pr.number}`);
            if (!pr.merged) {
              const existing = await github.rest.issues.listComments({
                ...context.repo,
                issue_number: pr.number
              });
              if (!existing.data.find(c => c.body && c.body.includes('Auto-merge workflow evaluated.'))) {
                await github.rest.issues.createComment({
                  ...context.repo,
                  issue_number: pr.number,
                  body: 'Auto-merge workflow evaluated. If conditions (minor/patch + labels) are satisfied, GitHub auto-merge will finalize once checks pass.'
                });
              }
            }
