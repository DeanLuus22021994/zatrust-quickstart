name: CodeQL Security Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * 1"  # Weekly on Mondays at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: codeql-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Security Analysis (CodeQL)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ["javascript-typescript"]
        include:
          - language: javascript-typescript
            build-mode: none
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          queries: +security-and-quality
          config-file: ./.github/codeql-config.yml

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          upload: true
          
      - name: Create issue on security findings
        if: failure() && github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Security Analysis Alert - CodeQL Findings';
            const body = [
              '🔍 **CodeQL Security Analysis detected potential issues**',
              '',
              `- **Workflow Run**: [${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})`,
              `- **Branch**: ${context.ref}`,
              `- **Language**: ${{ matrix.language }}`,
              '',
              '**Next Steps:**',
              '1. Review the Security tab for detailed findings',
              '2. Check SARIF artifacts for specific locations', 
              '3. Apply fixes for confirmed vulnerabilities',
              '4. Re-run security scan to validate fixes',
              '',
              '**References:**',
              '- Security findings: [Security Tab](${context.payload.repository.html_url}/security)',
              '- Remediation guide: `.github/prompts/automation.prompt.yml`'
            ].join('\n');
            
            const { data: issues } = await github.rest.issues.listForRepo({
              ...context.repo,
              state: 'open',
              labels: 'security,codeql-findings'
            });
            
            if (!issues.find(i => i.title === title)) {
              await github.rest.issues.create({
                ...context.repo,
                title,
                body,
                labels: ['security', 'codeql-findings', 'automation']
              });
            }
